zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: 36bff6c29af64692839d077febfc7079
      name: 'Templates/Network devices'
  templates:
    - uuid: c7213ba6362f4557ac014c43e8714830
      template: 'Cisco Nexus OSPF by SNMP export'
      name: 'Cisco Nexus OSPF by SNMP export'
      description: |
        https://github.com/AndAndr
        OSPF NBRs state and area state for Cisco Nexus
      groups:
        - name: 'Templates/Network devices'
      items:
        - uuid: 78cb57344b93498e94b68f3a8a6ecf2c
          name: ospfRouterId
          type: SNMP_AGENT
          snmp_oid: .1.3.6.1.2.1.14.1.1.0
          key: ospfRouterId
          delay: 10m
          history: 30d
          value_type: TEXT
          trends: '0'
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
          tags:
            - tag: application
              value: ospf
      discovery_rules:
        - uuid: b1e605adf38443258b1c5289af45377f
          name: 'Cisco nexus OSPF area discovery'
          type: SNMP_AGENT
          snmp_oid: 'discovery[{#SNMPVALUE},1.3.6.1.2.1.14.2.1.1]'
          key: ospfArea
          delay: 1h
          description: 'Обнаружение area OSPF'
          item_prototypes:
            - uuid: b4cbe4f56bb444bfbf12d410274ca78c
              name: 'OSPF Area {#SNMPVALUE} status'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.2.1.14.2.1.10.{#SNMPINDEX}'
              key: 'ospfAreaStatus[{#SNMPINDEX}]'
              history: 14d
              valuemap:
                name: 'SNMP OSPF area Status (ospfAreaStatus)'
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 3h
              tags:
                - tag: application
                  value: ospf
              trigger_prototypes:
                - uuid: 4b20fbbe3f504446b64116d0a4bb0e61
                  expression: 'last(/Cisco Nexus OSPF by SNMP export/ospfAreaStatus[{#SNMPINDEX}])<>1'
                  name: 'OSPF area {#SNMPINDEX} status is down'
                  priority: WARNING
                  tags:
                    - tag: scope
                      value: availability
        - uuid: 4dc87605161145ee8b7745da1c2f1982
          name: 'Cisco nexus OSPF NBR(s) discovery'
          type: SNMP_AGENT
          snmp_oid: 'discovery[{#SNMPVALUE},1.3.6.1.2.1.14.10.1.3]'
          key: ospfNbrRtrId
          delay: 1h
          description: 'Обнаружение соседей OSPF'
          item_prototypes:
            - uuid: bc307be3f9da404badd64ee94f4be1bd
              name: 'NbrRtrIP:{#SNMPINDEX} events'
              type: SNMP_AGENT
              snmp_oid: '.1.3.6.1.2.1.14.10.1.7.{#SNMPINDEX}'
              key: 'OspfNbrEvents[{#SNMPINDEX}]'
              history: 14d
              description: 'Количество раз, когда это соседнее отношение меняло свое состояние или возникала ошибка.'
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 10m
              tags:
                - tag: application
                  value: ospf
              trigger_prototypes:
                - uuid: 59c074e59f6847b8bcf5c365d4625233
                  expression: 'change(/Cisco Nexus OSPF by SNMP export/OspfNbrEvents[{#SNMPINDEX}])>1 and last(/Cisco Nexus OSPF by SNMP export/OspfNbrEvents[{#SNMPINDEX}])<>0'
                  name: 'OSPF: neighbor relationship has changed or an error has occurred with NbrRtrIP-{#SNMPINDEX}'
                  priority: INFO
                  tags:
                    - tag: scope
                      value: notice
            - uuid: 0764f42a9add4559985972651373b9e9
              name: 'NbrRtrIP:{#SNMPINDEX} retransmission queue length'
              type: SNMP_AGENT
              snmp_oid: '.1.3.6.1.2.1.14.10.1.8.{#SNMPINDEX}'
              key: 'OspfNbrLsRetransQLen[{#SNMPINDEX}]'
              history: 14d
              description: 'Текущая длина очереди повторной передачи.'
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 10m
              tags:
                - tag: application
                  value: ospf
              trigger_prototypes:
                - uuid: f9a318b471944584b347bec480de4d96
                  expression: 'avg(/Cisco Nexus OSPF by SNMP export/OspfNbrLsRetransQLen[{#SNMPINDEX}],#3)>{$RETRANSQLENMAX}'
                  name: 'OSPF: retransmission queue gt {$RETRANSQLENMAX} NbrRtrIP:{#SNMPINDEX}'
                  priority: INFO
                  tags:
                    - tag: scope
                      value: notice
            - uuid: b502230fac414793b5a685527226709a
              name: 'NbrRtrIP:{#SNMPINDEX}-NbrRtrId:{#SNMPVALUE} state'
              type: SNMP_AGENT
              snmp_oid: '.1.3.6.1.2.1.14.10.1.6.{#SNMPINDEX}'
              key: 'OspfNbrState[int:{#SNMPINDEX}-NbrRtrId:{#SNMPVALUE}]'
              history: 14d
              description: |
                Состояние отношений с соседом:
                down (1), attempt (2), init (3), twoWay (4), exchangeStart (5), exchange (6), loading (7), full (8)
              valuemap:
                name: 'SNMP OSPF Neighbor State (ospfNbrState)'
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 10m
              tags:
                - tag: application
                  value: ospf
              trigger_prototypes:
                - uuid: 3df9ac33627f4f85b4bc926eb48c6e1b
                  expression: 'last(/Cisco Nexus OSPF by SNMP export/OspfNbrState[int:{#SNMPINDEX}-NbrRtrId:{#SNMPVALUE}])<>8 and (last(/Cisco Nexus OSPF by SNMP export/OspfNbrState[int:{#SNMPINDEX}-NbrRtrId:{#SNMPVALUE}],#1)<>last(/Cisco Nexus OSPF by SNMP export/OspfNbrState[int:{#SNMPINDEX}-NbrRtrId:{#SNMPVALUE}],#2))=1'
                  name: 'OSPF: Check RtrId-{#SNMPVALUE} neighbor state NbrRtrIP-{#SNMPINDEX}'
                  opdata: 'NBR State={ITEM.LASTVALUE1}'
                  priority: AVERAGE
                  description: |
                    Доступно ручное закрытие, если TwoWay (4) - это норма.
                    Триггер повторно не стреляет.
                  tags:
                    - tag: scope
                      value: availability
      tags:
        - tag: application
          value: ospf
        - tag: class
          value: network
        - tag: target
          value: cisco
        - tag: target
          value: cisco-nexus
      macros:
        - macro: '{$RETRANSQLENMAX}'
          value: '5'
      valuemaps:
        - uuid: 9cfc4bfbc49344bb9076c6cd27551886
          name: 'SNMP OSPF Admin State (ospfAdminStat)'
          mappings:
            - value: '1'
              newvalue: Enabled
            - value: '2'
              newvalue: Disabled
        - uuid: 79e1302ebe084dc6981efdd0417126a5
          name: 'SNMP OSPF area Status (ospfAreaStatus)'
          mappings:
            - value: '1'
              newvalue: Enabled
            - value: '2'
              newvalue: Disabled
        - uuid: 9b297bb12d164e4db2f287acded89e48
          name: 'SNMP OSPF Neighbor State (ospfNbrState)'
          mappings:
            - value: '1'
              newvalue: Down
            - value: '2'
              newvalue: Attempt
            - value: '3'
              newvalue: Init
            - value: '4'
              newvalue: TwoWay
            - value: '5'
              newvalue: ExchangeStart
            - value: '6'
              newvalue: Exchange
            - value: '7'
              newvalue: Loading
            - value: '8'
              newvalue: Full
